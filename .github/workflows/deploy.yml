deploy:
  needs: build
  runs-on: ubuntu-latest
  if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
  steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          IMAGE_NAME="${{ needs.build.outputs.image_name }}"

          if [ -z "$IMAGE_NAME" ]; then
            echo "IMAGE_NAME is not set. Exiting."
            exit 1
          fi

          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            CONTAINER_NAME="prod-app"
            PORT="8080"
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            CONTAINER_NAME="dev-app"
            PORT="8081"
          fi

          sudo docker stop $CONTAINER_NAME || true
          sudo docker rm $CONTAINER_NAME || true
          sudo docker pull $IMAGE_NAME

          sudo docker run -d -p $PORT:8080 --name $CONTAINER_NAME \
            -e MONGO_URI="${{ secrets.MONGO_URI }}" \
            -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            -e MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}" \
            --restart=always \
            $IMAGE_NAME

          sudo docker image prune -f